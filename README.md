# OZON 智能爬虫系统

> 面向跨境电商团队的OZON商品数据采集与分析平台，支持关键词批量采集、定时调度、数据导出和利润计算。

## 系统架构

```
ozon-scraper/
├── backend/                    # 后端服务
│   └── app/
│       ├── core/               # 核心配置
│       │   └── config.py       # 系统配置
│       ├── models/             # 数据模型
│       │   └── database.py     # SQLAlchemy模型
│       ├── scrapers/           # 爬虫引擎
│       │   └── ozon_scraper.py # OZON爬虫核心
│       ├── services/           # 业务服务
│       │   ├── scraper_service.py   # 爬虫服务
│       │   ├── export_service.py    # 导出服务
│       │   └── scheduler_service.py # 调度服务
│       └── main.py             # FastAPI主应用
├── frontend/                   # 前端界面
│   └── index.html              # Web管理界面
├── data/                       # 数据目录
│   └── exports/                # 导出文件
├── logs/                       # 日志目录
├── Dockerfile                  # Docker镜像
├── docker-compose.yml          # Docker编排
├── requirements.txt            # Python依赖
├── start.py                    # 启动脚本
└── README.md                   # 项目文档
```

## 核心功能

### 1. OZON商品数据采集

- **关键词搜索采集**：输入俄语关键词，自动搜索并采集商品数据
- **进口商品筛选**：支持仅采集OZON Global进口商品
- **无限滚动加载**：自动滚动页面，持续加载新商品，单次最多采集50,000件
- **智能反爬策略**：随机UA、请求延迟、平滑滚动、反检测脚本注入

### 2. 采集数据字段

| 字段 | 说明 | 来源 |
|------|------|------|
| SKU | 商品唯一标识 | 搜索页 |
| 商品标题 | 完整商品名称 | 搜索页 |
| 商品图片 | 主图URL | 搜索页 |
| 商品链接 | 商品详情页URL | 搜索页 |
| 价格 | 当前售价（₽） | 搜索页 |
| 原价 | 折扣前价格（₽） | 搜索页 |
| 折扣 | 折扣百分比 | 搜索页 |
| 类目 | 商品分类路径 | 详情页 |
| 品牌 | 品牌名称 | 搜索页 |
| 评分 | 商品评分 | 搜索页 |
| 评论数 | 评论数量 | 搜索页 |
| 月销量 | 近30天销量 | 详情页 |
| 周销量 | 近7天销量 | 详情页 |
| 付费推广（28天参与） | 推广天数 | 详情页 |
| 广告费用占比 | 广告成本比例 | 详情页 |
| 卖家类型 | Ozon/FBO/FBS等 | 搜索页 |
| 卖家名称 | 卖家店铺名 | 详情页 |
| 商品创建时间 | 上架日期 | 详情页 |
| 被跟数量 | 跟卖卖家数 | 详情页 |
| 被跟最低价 | 跟卖最低价格 | 详情页 |
| 被跟最低价链接 | 最低价商品链接 | 详情页 |
| 长度/宽度/高度 | 商品尺寸（cm） | 详情页 |
| 重量 | 商品重量（g） | 详情页 |
| 配送信息 | 配送方式和时间 | 搜索页 |

### 3. 任务调度

- **顺序模式**：按关键词顺序逐个采集，每个采集到目标数量后切换
- **定时切换**：每个关键词采集指定时间后自动切换到下一个
- **定量切换**：每个关键词采集指定数量后自动切换
- **Cron定时**：支持Cron表达式配置定时自动采集

### 4. 数据导出

- **Excel导出**：带格式的.xlsx文件，含表头样式和冻结首行
- **CSV导出**：UTF-8编码，兼容Excel打开
- **JSON导出**：结构化JSON数据

### 5. 利润计算

- 输入拼多多采购价，自动计算利润
- 支持自定义运费、佣金率、汇率
- 计算结果自动保存到数据库

## 快速开始

### 方式一：Docker部署（推荐）

```bash
# 克隆项目
git clone https://github.com/572150592-cloud/pachong.git
cd pachong

# 启动服务
docker-compose up -d

# 访问管理界面
# http://localhost:8000
```

### 方式二：本地运行

```bash
# 1. 安装Python依赖
pip install -r requirements.txt

# 2. 安装Playwright浏览器
playwright install chromium
playwright install-deps chromium

# 3. 创建配置文件
cp .env.example .env

# 4. 启动服务
python start.py

# 5. 访问管理界面
# http://localhost:8000
```

## 使用指南

### 第一步：添加关键词

1. 进入「关键词管理」页面
2. 点击「添加关键词」
3. 输入俄语关键词（如 `наушники`）和中文翻译（如 `耳机`）
4. 设置优先级和最大采集数

### 第二步：创建采集任务

1. 进入「采集任务」页面
2. 点击「新建任务」
3. 输入要采集的关键词（每行一个）
4. 选择切换模式和参数
5. 点击「开始采集」

### 第三步：查看和导出数据

1. 进入「商品数据」页面查看采集结果
2. 使用搜索和筛选功能定位数据
3. 点击「导出Excel」或「导出CSV」下载数据

### 第四步：计算利润

1. 进入「利润计算」页面
2. 输入商品SKU和拼多多采购价
3. 设置运费、佣金率和汇率
4. 点击「计算利润」查看结果

### 第五步：设置定时任务

1. 进入「定时任务」页面
2. 点击「创建定时任务」
3. 设置任务名称、关键词和Cron表达式
4. 系统将按计划自动执行采集

## API接口文档

启动服务后访问 `http://localhost:8000/docs` 查看完整的Swagger API文档。

### 主要接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/dashboard` | 获取仪表板数据 |
| GET | `/api/keywords` | 获取关键词列表 |
| POST | `/api/keywords` | 创建关键词 |
| PUT | `/api/keywords/{id}` | 更新关键词 |
| DELETE | `/api/keywords/{id}` | 删除关键词 |
| POST | `/api/tasks/start` | 启动采集任务 |
| POST | `/api/tasks/stop` | 停止采集任务 |
| GET | `/api/tasks` | 获取任务列表 |
| GET | `/api/tasks/status` | 获取采集状态 |
| GET | `/api/products` | 获取商品列表 |
| GET | `/api/products/{sku}` | 获取商品详情 |
| POST | `/api/export` | 导出数据 |
| POST | `/api/profit/calculate` | 计算利润 |
| GET | `/api/schedules` | 获取定时任务列表 |
| POST | `/api/schedules` | 创建定时任务 |
| DELETE | `/api/schedules/{id}` | 删除定时任务 |

## 反爬策略说明

本系统采用多层反爬策略，最大限度降低被封禁风险：

1. **浏览器指纹伪装**：隐藏WebDriver标识、修改navigator属性、注入Chrome对象
2. **随机User-Agent**：每次启动随机选择UA，模拟不同浏览器
3. **请求延迟**：每次操作间随机延迟1-4秒，模拟人类行为
4. **平滑滚动**：分步滚动页面，避免瞬间跳转
5. **代理IP支持**：可配置代理IP池，分散请求来源
6. **Cookie管理**：自动管理和持久化Cookie

### 代理配置

在系统设置中配置代理IP，格式为：
```
http://username:password@host:port
```

建议使用俄罗斯地区的住宅代理，以获得最佳效果。

## 生产环境部署建议

### 500人电商公司部署方案

1. **数据库**：将SQLite替换为MySQL 8.0，修改 `.env` 中的 `DATABASE_URL`
2. **代理IP**：配置5-10个俄罗斯住宅代理IP，轮换使用
3. **并发控制**：建议同时运行不超过3个采集任务，避免触发反爬
4. **定时策略**：错峰采集，避开OZON高峰时段（莫斯科时间10:00-22:00）
5. **数据备份**：配置MySQL自动备份，每日增量备份
6. **监控告警**：对接飞书/钉钉WebHook，采集失败时自动通知

### 扩展方向

- 接入拼多多RPA以图搜图模块
- 对接ERP系统自动同步商品数据
- 添加竞品监控和价格预警功能
- 构建数据分析看板

## 技术栈

| 组件 | 技术 | 说明 |
|------|------|------|
| 后端框架 | FastAPI | 高性能异步Web框架 |
| 爬虫引擎 | Playwright | 无头浏览器自动化 |
| 数据库 | SQLite/MySQL | 数据持久化 |
| ORM | SQLAlchemy | 数据库操作 |
| 任务调度 | APScheduler | 定时任务管理 |
| 前端 | 原生HTML/CSS/JS | 轻量级管理界面 |
| 部署 | Docker | 容器化部署 |

## 许可证

本项目仅供学习和内部使用，请遵守OZON平台的使用条款和robots.txt规则。
