# OZON智能爬虫系统 — 项目交付文档

## 一、系统概述

本系统是为500人规模电商公司定制开发的OZON商品数据采集与分析平台，采用**Chrome浏览器扩展 + FastAPI后端服务**的双层架构。Chrome扩展运行在用户真实浏览器环境中，利用用户自身的IP地址和Cookie，有效绕过OZON平台的反爬虫机制；后端服务负责数据接收、存储、管理、导出和利润计算。

## 二、系统架构

```
┌─────────────────────────────────────────────────────────┐
│                    用户真实浏览器 (Chrome)                  │
│  ┌─────────────────────────────────────────────────┐    │
│  │         Chrome Extension (OZON采集助手)           │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────────┐  │    │
│  │  │ Popup UI │  │Background│  │Content Script│  │    │
│  │  │ 控制面板  │  │ 任务调度  │  │ DOM数据提取   │  │    │
│  │  └──────────┘  └────┬─────┘  └──────┬───────┘  │    │
│  └──────────────────────┼──────────────┼──────────┘    │
│                         │              │               │
│                    OZON搜索页面 ←───── 自动滚动加载       │
└─────────────────────────┼──────────────────────────────┘
                          │ HTTP POST (批量推送)
                          ▼
┌─────────────────────────────────────────────────────────┐
│                  FastAPI 后端服务                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────┐ │
│  │ API接口   │  │ 数据存储  │  │ 任务调度  │  │数据导出 │ │
│  │ /api/*   │  │ SQLite   │  │ APScheduler│ │Excel/CSV│ │
│  └──────────┘  └──────────┘  └──────────┘  └────────┘ │
│  ┌──────────────────────────────────────────────────┐  │
│  │              Web管理界面 (前端)                     │  │
│  │  仪表板 | 关键词管理 | 任务管理 | 商品数据 | 利润计算  │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

## 三、技术选型

| 组件 | 技术方案 | 选型理由 |
|------|---------|---------|
| 数据采集端 | Chrome Extension (Manifest V3) | 运行在用户真实浏览器中，使用用户IP和Cookie，天然绕过反爬机制 |
| 页面数据提取 | Content Script (DOM解析) | 直接从OZON搜索结果页DOM中提取数据，无需进入商品详情页，速度快 |
| 后端框架 | FastAPI (Python) | 高性能异步框架，自带API文档，适合数据密集型应用 |
| 数据库 | SQLite（开发）/ PostgreSQL（生产） | SQLite零配置开箱即用，生产环境可无缝切换PostgreSQL |
| 任务调度 | APScheduler | 成熟的Python调度库，支持Cron表达式和间隔调度 |
| 前端界面 | 原生HTML/CSS/JS | 零依赖，加载快，无需构建工具 |

## 四、可采集的数据字段

| 序号 | 字段名 | 中文名称 | 数据来源 | 说明 |
|------|--------|---------|---------|------|
| 1 | sku | SKU编号 | 搜索页URL | 从商品链接中提取 |
| 2 | title | 商品标题 | 搜索页DOM | 商品卡片中的标题文本 |
| 3 | product_url | 商品链接 | 搜索页DOM | 完整的商品详情页URL |
| 4 | image_url | 商品图片 | 搜索页DOM | 商品主图URL |
| 5 | price | 当前价格 | 搜索页DOM | 当前售价（卢布） |
| 6 | original_price | 原价 | 搜索页DOM | 折扣前原价 |
| 7 | discount_percent | 折扣比例 | 搜索页DOM | 折扣百分比 |
| 8 | category | 类目 | 搜索页/详情页 | 商品所属类目 |
| 9 | brand | 品牌 | 搜索页DOM | 商品品牌名称 |
| 10 | rating | 评分 | 搜索页DOM | 商品评分（1-5） |
| 11 | review_count | 评论数 | 搜索页DOM | 用户评论数量 |
| 12 | monthly_sales | 月销量 | 需第三方API | 月度销售量 |
| 13 | weekly_sales | 周销量 | 需第三方API | 周度销售量 |
| 14 | paid_promo_days | 付费推广天数 | 需第三方API | 28天内参与推广天数 |
| 15 | ad_cost_ratio | 广告费用占比 | 需第三方API | 广告费用占销售额比例 |
| 16 | seller_type | 卖家类型 | 搜索页DOM | FBO/FBS/Ozon等 |
| 17 | seller_name | 卖家名称 | 详情页 | 卖家店铺名称 |
| 18 | creation_date | 商品创建时间 | 需第三方API | 商品首次上架时间 |
| 19 | followers_count | 被跟数量 | 需第三方API | 跟卖该商品的卖家数 |
| 20 | follower_min_price | 被跟最低价 | 需第三方API | 跟卖者中的最低售价 |
| 21 | follower_min_url | 被跟最低价链接 | 需第三方API | 最低价跟卖者的链接 |
| 22 | length_cm | 长度 | 详情页 | 商品包装长度（cm） |
| 23 | width_cm | 宽度 | 详情页 | 商品包装宽度（cm） |
| 24 | height_cm | 高度 | 详情页 | 商品包装高度（cm） |
| 25 | weight_g | 重量 | 详情页 | 商品重量（g） |
| 26 | delivery_info | 配送信息 | 搜索页DOM | 预计送达时间 |
| 27 | pdd_purchase_price | 拼多多采购价 | 拼多多RPA | 人民币采购价 |
| 28 | profit_rub | 利润（卢布） | 系统计算 | 自动计算的利润 |
| 29 | profit_cny | 利润（人民币） | 系统计算 | 换算后的人民币利润 |

> **说明**：标注"搜索页DOM"的字段可直接从搜索结果页提取，无需进入商品详情页。标注"需第三方API"的字段（如销量、推广数据、跟卖信息等）需要对接类似BCS的第三方数据服务API才能获取，这些数据OZON官方页面上不直接展示。

## 五、项目文件结构

```
pachong/
├── extension/                    # Chrome浏览器扩展
│   ├── manifest.json            # 扩展配置文件（Manifest V3）
│   ├── js/
│   │   ├── background.js        # 后台服务：消息路由、数据存储、API通信、任务调度
│   │   └── content.js           # 内容脚本：DOM数据提取、自动滚动、浮动面板
│   ├── css/
│   │   └── content.css          # 浮动控制面板样式
│   ├── popup/
│   │   ├── popup.html           # 弹出窗口界面
│   │   └── popup.js             # 弹出窗口逻辑
│   └── icons/                   # 扩展图标
├── backend/                      # FastAPI后端服务
│   └── app/
│       ├── main.py              # 主应用（API路由、启动配置）
│       ├── models/
│       │   └── database.py      # 数据库模型（SQLAlchemy ORM）
│       ├── scrapers/
│       │   └── ozon_scraper.py  # Playwright爬虫引擎（备用方案）
│       ├── services/
│       │   ├── scraper_service.py   # 爬虫服务层
│       │   ├── export_service.py    # 数据导出服务（Excel/CSV/JSON）
│       │   └── scheduler_service.py # 定时调度服务
│       └── core/
│           └── config.py        # 系统配置
├── frontend/
│   └── index.html               # Web管理界面（单文件SPA）
├── data/                         # 数据目录
├── logs/                         # 日志目录
├── Dockerfile                    # Docker镜像配置
├── docker-compose.yml           # Docker Compose编排
├── requirements.txt             # Python依赖
├── .env.example                 # 环境变量示例
└── README.md                    # 项目说明文档
```

## 六、使用指南

### 6.1 Chrome扩展安装

1. 打开Chrome浏览器，访问 `chrome://extensions/`
2. 开启右上角的"开发者模式"
3. 点击"加载已解压的扩展程序"
4. 选择项目中的 `extension/` 目录
5. 扩展安装成功后，工具栏会出现蓝色搜索图标

### 6.2 使用Chrome扩展采集数据

**方式一：通过扩展弹窗操作**

1. 点击工具栏的扩展图标，打开弹窗面板
2. 在"搜索关键词"文本框中输入关键词（每行一个）
3. 设置每个关键词的最大采集数量（默认5000，最大50000）
4. 选择切换模式：顺序采集 / 按数量切换 / 按时间切换
5. 如需仅采集进口商品，勾选"仅采集进口商品"
6. 点击"开始采集"按钮

**方式二：通过页面浮动面板操作**

1. 打开OZON网站（www.ozon.ru），页面右上角会出现浮动控制面板
2. 在面板中输入关键词，设置参数
3. 点击"开始采集"按钮
4. 面板会实时显示采集进度

### 6.3 数据导出

扩展支持两种导出方式：

- **本地导出**：点击"导出CSV"或"导出JSON"按钮，数据直接下载到本地
- **推送到服务器**：输入后端服务器地址（如 `http://your-server:8000`），点击"推送"按钮，数据批量上传到后端数据库

### 6.4 后端服务部署

**方式一：直接运行**

```bash
cd backend
pip install -r ../requirements.txt
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000
```

**方式二：Docker部署（推荐生产环境）**

```bash
docker-compose up -d
```

部署成功后，访问 `http://your-server:8000` 即可打开Web管理界面。

### 6.5 Web管理界面功能

| 页面 | 功能说明 |
|------|---------|
| 仪表板 | 总览商品数量、关键词数、任务数、运行状态 |
| 关键词管理 | 添加/编辑/删除搜索关键词，设置优先级和最大采集数 |
| 采集任务 | 查看任务历史、状态、采集数量、耗时 |
| 商品数据 | 浏览所有采集到的商品，支持搜索、筛选、分页、导出Excel/CSV |
| 定时任务 | 创建基于Cron表达式的定时采集任务 |
| 利润计算 | 输入拼多多采购价，自动计算利润和利润率 |
| 系统设置 | 配置代理IP、汇率、默认参数等 |

## 七、API接口列表

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/dashboard | 获取仪表板数据 |
| GET | /api/keywords | 获取关键词列表 |
| POST | /api/keywords | 创建关键词 |
| PUT | /api/keywords/{id} | 更新关键词 |
| DELETE | /api/keywords/{id} | 删除关键词 |
| POST | /api/tasks/start | 启动采集任务 |
| POST | /api/tasks/stop | 停止采集任务 |
| GET | /api/tasks | 获取任务列表 |
| GET | /api/tasks/status | 获取当前采集状态 |
| GET | /api/products | 获取商品列表（分页/筛选/排序） |
| GET | /api/products/{sku} | 获取单个商品详情 |
| **POST** | **/api/products/batch** | **批量接收Chrome扩展推送的商品数据** |
| POST | /api/profit/calculate | 计算单个商品利润 |
| POST | /api/export | 导出商品数据（Excel/CSV/JSON） |
| GET | /api/schedules | 获取定时任务列表 |
| POST | /api/schedules | 创建定时任务 |
| DELETE | /api/schedules/{id} | 删除定时任务 |

## 八、反爬虫策略说明

OZON平台的反爬虫机制非常严格，经实测验证：

1. **数据中心IP直接封禁**：从云服务器（AWS、阿里云等）发起的请求会被直接返回403
2. **浏览器指纹检测**：Playwright等自动化工具会被检测到并拦截
3. **行为分析**：异常的请求频率和模式会触发验证码或封禁

本系统采用的应对策略：

| 策略 | 实现方式 |
|------|---------|
| 真实浏览器环境 | Chrome扩展运行在用户真实Chrome浏览器中，无自动化特征 |
| 用户真实IP | 使用用户自身的网络IP，非数据中心IP |
| 真实Cookie | 利用用户已登录的OZON账号Cookie |
| 模拟人类行为 | 随机滚动速度、随机等待时间、平滑滚动动画 |
| 频率控制 | 滚动间隔1.5-3.5秒随机，避免固定频率 |
| 数据量控制 | 单次最多5万件，避免过度采集 |

## 九、后续扩展计划

1. **拼多多RPA模块**：通过RPA工具实现拼多多以图搜图功能，自动获取采购价
2. **销量数据对接**：对接第三方数据API（如类似BCS的服务）获取销量、推广等深度数据
3. **多用户支持**：添加用户认证和权限管理，支持团队协作
4. **数据分析看板**：添加数据可视化图表，展示价格趋势、销量排行等
5. **自动利润计算**：对接拼多多数据后，实现全自动利润分析

## 十、注意事项

1. Chrome扩展需要在能访问OZON的网络环境下使用（通常需要俄罗斯IP或VPN）
2. 建议使用独立的Chrome Profile运行扩展，避免影响日常浏览
3. 单次采集建议不超过5万件商品，避免浏览器内存溢出
4. 生产环境建议将SQLite替换为PostgreSQL或MySQL
5. 后端服务建议部署在公司内网服务器上，Chrome扩展通过内网地址推送数据
